---
  name: build-chart
  on:
    workflow_call:
      inputs:
        service_name:
          required: true
          type: string
        namespace:
          required: true
          type: string
      secrets:
        ACCESS_TOKEN:
          required: true
  jobs:
    publish:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v4
      name: Checkout
      with:
        token: ${{ secrets.ACCESS_TOKEN }}

    - name: create env branch
      shell: bash
      run: |
        git checkout --orphan env/prod  && git rm -rf . || git swich env/prod
        git pull --set-upstream origin env/prod || true
        rm -rf charts
        rm -rf application


    - uses: actions/download-artifact@v4
      with:
        name: charts
        path: charts

    - name: generate argocd application
      shell: bash
      env:
        APP_NAME: ${{ inputs.service_name }}
        REPO_NAME: ${{ inputs.service_name }}
        NAMESPACE: ${{ inputs.namespace }}
      run: |
        mkdir -p application
        cat << EOF > application/argocd.tpl
        apiVersion: argoproj.io/v1alpha1
        kind: Application
        metadata:
          name: ${APP_NAME}
          namespace: argocd
          finalizers:
          - resources-finalizer.argocd.argoproj.io
        spec:
          destination:
            namespace: ${NAMESPACE}
            server: https://kubernetes.default.svc
          project: default
          source:
            path: charts
            repoURL: https://github.com/mohamedragab2024/${REPO_NAME}.git
            targetRevision: env/prod
            helm:
              valueFiles:
                - values-live.yaml
          syncPolicy:
            automated:
              prune: true
              selfHeal: true
              allowEmpty: true
            syncOptions:
              - CreateNamespace=true
        EOF
        envsubst < application/argocd.tpl > application/${APP_NAME}-argocd-app.yaml
        rm -f application/argocd.tpl

    - name: publish charts
      shell: bash
      run: |
        git config --global user.email "m.ragab6010@gmail.com"
        git config --global user.name "mohamedragab2024"
        git add .
        git commit -m "Create a new version" || true
        git push --set-upstream origin env/prod || true
